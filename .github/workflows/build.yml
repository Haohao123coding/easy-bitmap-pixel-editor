name: Build on Release

on:
  release:
    types: [published, edited]  # 发布或编辑 Release 时触发
  workflow_dispatch:            # 添加手动触发，方便测试

jobs:
  build-multi-platform:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Ubuntu/Linux 配置
          - os: ubuntu-latest
            asset_name: ebpe-linux
            compile_command: g++ ebpe.cpp -o ebpe -O2 -std=c++14 -static
            output_path: ./ebpe
            file_type: application/octet-stream
          
          # Windows 配置
          - os: windows-latest
            asset_name: ebpe-windows.exe
            compile_command: g++ ebpe.cpp -o ebpe.exe -O2 -std=c++14 -static
            output_path: ./ebpe.exe
            file_type: application/x-msdownload

    steps:
      # 步骤 1: 获取代码
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name || github.ref }}  # Release tag 或默认分支
      
      # 步骤 2: 设置编译环境
      - name: Setup build environment
        run: |
          echo "Building for $RUNNER_OS..."
          echo "Release tag: ${{ github.event.release.tag_name }}"
          
          if [ "$RUNNER_OS" = "Linux" ]; then
            sudo apt update
            sudo apt install -y g++ build-essential libc6-dev libstdc++-12-dev
          elif [ "$RUNNER_OS" = "Windows" ]; then
            choco install mingw -y
            echo "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin" >> $GITHUB_PATH
          fi
      
      # 步骤 3: 显示编译器信息
      - name: Show compiler version
        run: |
          g++ --version || echo "g++ not available"
          which g++ || echo "g++ not found in PATH"
      
      # 步骤 4: 编译项目
      - name: Compile project
        run: ${{ matrix.compile_command }}
        shell: bash   # 强制用 bash，避免 Windows PowerShell 不识别
      
      # 步骤 5: 验证生成的文件
      - name: Verify binary
        run: |
          if [ -f "${{ matrix.output_path }}" ]; then
            echo "✅ Build successful!"
            ls -la "${{ matrix.output_path }}"
            if [ "$RUNNER_OS" = "Linux" ]; then
              file "${{ matrix.output_path }}"
            fi
          else
            echo "❌ Build failed - output file not found"
            ls -la ./
            exit 1
          fi
      
      # 步骤 6: 上传编译好的文件到 Release
      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ matrix.output_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # 步骤 7: 显示完成信息
      - name: Completion message
        run: |
          echo "🎉 Build completed for $RUNNER_OS"
          echo "📦 Asset uploaded: ${{ matrix.asset_name }}"
          echo "🏷️ Release: ${{ github.event.release.name }}"
