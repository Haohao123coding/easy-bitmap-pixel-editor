name: Build on Release

on:
  release:
    types: [published, edited]  # å‘å¸ƒæˆ–ç¼–è¾‘ Release æ—¶è§¦å‘
  workflow_dispatch:  # æ·»åŠ æ‰‹åŠ¨è§¦å‘ï¼Œæ–¹ä¾¿æµ‹è¯•

jobs:
  build-multi-platform:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Ubuntu/Linux é…ç½®
          - os: ubuntu-latest
            asset_name: ebpe-linux
            compile_command: g++ ebpe.cpp -o ebpe -O2 -std=c++14 -static
            output_path: ./ebpe
            file_type: application/octet-stream
          
          # Windows é…ç½®
          - os: windows-latest
            asset_name: ebpe-windows.exe
            compile_command: g++ ebpe.cpp -o ebpe.exe -O2 -std=c++14 -static
            output_path: ./ebpe.exe
            file_type: application/x-msdownload

    steps:
      # æ­¥éª¤ 1: è·å–ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}  # æ£€å‡º Release å¯¹åº”çš„ tag
      
      # è°ƒè¯•ä¿¡æ¯ï¼šæ£€æŸ¥ä»£ç æ˜¯å¦æ­£ç¡®æ£€å‡º
      - name: Debug - Verify checkout
        run: |
          echo "ğŸ“‹ æ£€å‡ºåçš„æ–‡ä»¶åˆ—è¡¨:"
          ls -la
          echo "ğŸ” æ£€æŸ¥ ebpe.cpp æ˜¯å¦å­˜åœ¨:"
          if [ -f "ebpe.cpp" ]; then
            echo "âœ… ebpe.cpp å­˜åœ¨"
            echo "ğŸ“„ æ–‡ä»¶å‰å‡ è¡Œ:"
            head -5 ebpe.cpp
          else
            echo "âŒ ebpe.cpp ä¸å­˜åœ¨ï¼"
            echo "å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            exit 1
          fi

      # æ­¥éª¤ 2: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      - name: Setup build environment
        run: |
          echo "Building for $RUNNER_OS..."
          echo "Release tag: ${{ github.event.release.tag_name }}"
          
          # æ ¹æ®ä¸åŒç³»ç»Ÿå®‰è£…ä¾èµ–
          if [ "$RUNNER_OS" = "Linux" ]; then
            sudo apt update
            sudo apt install -y g++ build-essential
          elif [ "$RUNNER_OS" = "Windows" ]; then
            choco install mingw -y
            echo "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin" >> $GITHUB_PATH
          fi

      # æ­¥éª¤ 3: æ˜¾ç¤ºç¼–è¯‘å™¨ä¿¡æ¯
      - name: Show compiler version
        run: |
          g++ --version || echo "g++ not available"
          which g++ || echo "g++ not found in PATH"

      # æ­¥éª¤ 4: ç¼–è¯‘é¡¹ç›®
      - name: Compile project
        run: ${{ matrix.compile_command }}
        
      # æ­¥éª¤ 5: éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
      - name: Verify binary
        run: |
          if [ -f "${{ matrix.output_path }}" ]; then
            echo "âœ… Build successful!"
            ls -la "${{ matrix.output_path }}"
            file "${{ matrix.output_path }}" || echo "File command not available"
          else
            echo "âŒ Build failed - output file not found"
            ls -la ./
            exit 1
          fi

      # æ­¥éª¤ 6: ä¸Šä¼ ç¼–è¯‘å¥½çš„æ–‡ä»¶åˆ° Release
      - name: Upload to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}  # ä½¿ç”¨ Release æä¾›çš„ä¸Šä¼ URL
          asset_path: ${{ matrix.output_path }}
          asset_name: ${{ matrix.asset_name }}
          asset_content_type: ${{ matrix.file_type }}

      # æ­¥éª¤ 7: æ˜¾ç¤ºå®Œæˆä¿¡æ¯
      - name: Completion message
        run: |
          echo "ğŸ‰ Build completed for $RUNNER_OS"
          echo "ğŸ“¦ Asset uploaded: ${{ matrix.asset_name }}"
          echo "ğŸ·ï¸ Release: ${{ github.event.release.name }}"
